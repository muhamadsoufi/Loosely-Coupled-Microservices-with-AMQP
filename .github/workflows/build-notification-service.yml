name: Build & Push NotificationService to ECR

on:
  workflow_dispatch:
#  push:
#    branches:
#      - main
#    paths:
#      - 'notification-service/**'
#      - '.github/workflows/build-notification-service.yml'

env:
  ECR_REPOSITORY: eks_foundation_stack_repo
  IMAGE_TAG: ${{ github.sha }}
  AWS_REGION: us-east-1

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarQube Code Analysis
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          projectBaseDir: notification-service
          args: >
            -Dsonar.projectKey=notification-service
            -Dsonar.sources=.
            -Dsonar.python.version=3.11
        continue-on-error: true

        
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActions-Infra-Deployer-Role
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker image
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          cd notification-service
          docker build -t $REGISTRY/$ECR_REPOSITORY:notifservice-$IMAGE_TAG .
          echo "IMAGE_URI=$REGISTRY/$ECR_REPOSITORY:notifservice-$IMAGE_TAG" >> $GITHUB_ENV
          echo "REGISTRY=$REGISTRY" >> $GITHUB_ENV

      - name: Push image to Amazon ECR
        run: |
          docker push ${{ env.REGISTRY }}/$ECR_REPOSITORY:notifservice-$IMAGE_TAG
          echo "Image pushed: ${{ env.IMAGE_URI }}"

      - name: Update Helm values
        run: |
          # Update the image tag in notification-service values.yaml
          sed -i "s|tag: .*|tag: notifservice-$IMAGE_TAG|g" helm-charts/notification-service/values.yaml
          sed -i "s|repository: .*|repository: ${{ env.REGISTRY }}/$ECR_REPOSITORY|g" helm-charts/notification-service/values.yaml
          
          # Verify changes
          cat helm-charts/notification-service/values.yaml | grep -A 2 "image:"

      - name: Commit and push to prod branch
        env:
          TOKEN: ${{ secrets.TOKEN }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git remote set-url origin https://x-access-token:${TOKEN}@github.com/${{ github.repository }}.git
          
          # Commit the helm values changes on main branch
          git add helm-charts/notification-service/values.yaml
          git commit -m "chore: update notification-service image tag to $IMAGE_TAG [skip ci]" || echo "No changes to commit"
          MAIN_COMMIT=$(git rev-parse HEAD)
          
          # Fetch and checkout prod branch
          git fetch origin prod 2>/dev/null || echo "prod branch does not exist"
          git checkout -b prod origin/prod 2>/dev/null || git checkout prod
          
          # Merge main with their strategy (accept all incoming changes)
          git merge -X theirs --no-ff origin/main -m "Merge main into prod [skip ci]"
          
          # Now apply our Helm values from main
          git checkout $MAIN_COMMIT -- helm-charts/notification-service/values.yaml
          git add helm-charts/notification-service/values.yaml
          git commit -m "chore: apply notification-service image tag $IMAGE_TAG [skip ci]" || echo "No changes"
          
          git push origin prod --force-with-lease
          echo "âœ… Updated prod branch with new image tag"

      - name: Slack Notification (Optional)
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: "NotificationService Build: ${{ job.status }}\nImage: ${{ env.IMAGE_URI }}\nCommit: ${{ github.sha }}"
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
